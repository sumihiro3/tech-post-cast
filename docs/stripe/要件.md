# Stripe サブスクリプション課金統合 要件定義

## 概要

Tech Post Cast アプリケーションにおけるStripeサブスクリプション課金システムの要件を定義する。

## 1. ユーザー操作によるトリガーイベント

### 1.1 サブスクリプション開始関連

#### 1.1.1 新規サブスクリプション登録

**トリガー:** ユーザーがプラン選択画面でプランを選択し、決済ボタンをクリック

- **フロー:** Stripe Checkout Session作成 → Stripe決済画面へリダイレクト
- **必要な処理:**
    - Checkout Session作成（Stripe API）
    - セッション情報の一時保存
    - 決済完了後のリダイレクト処理
- **期待する結果:** サブスクリプション作成、課金開始

### 1.2 サブスクリプション変更関連

#### 1.2.1 プラン変更（アップグレード・ダウングレード）

**トリガー:** ユーザーがCustomer PortalまたはアプリUI内でプラン変更を実行

- **フロー:** 既存サブスクリプションの変更またはProration処理
- **必要な処理:**
    - 現在のサブスクリプション状態確認
    - 新プランへの変更処理
    - 料金の日割り計算（Proration）
- **期待する結果:** 新プランの制限値適用、料金調整

#### 1.2.2 支払い方法変更

**トリガー:** ユーザーがCustomer Portalで支払い方法を変更

- **フロー:** Stripe Customer Portal経由での変更
- **必要な処理:**
    - 新しい支払い方法の検証
    - デフォルト支払い方法の更新
- **期待する結果:** 次回課金時に新しい支払い方法を使用

### 1.3 サブスクリプション停止関連

#### 1.3.1 サブスクリプション解約

**トリガー:** ユーザーがCustomer Portalまたはアプリ内で解約を実行

- **フロー:** サブスクリプションのキャンセル予約
- **必要な処理:**
    - 現在の請求期間終了時点でのキャンセル設定
    - 解約確認メール送信
    - 機能アクセスの段階的制限
- **期待する結果:** 請求期間終了時にサービス停止

## 2. 期間・システムによるトリガーイベント

### 2.1 請求サイクル関連

#### 2.1.1 定期課金処理

**トリガー:** Stripeによる自動的な請求サイクル到達

- **タイミング:** 月次または年次の請求日
- **必要な処理:**
    - 支払い方法への課金実行
    - 請求書生成
    - サブスクリプション期間延長
- **期待する結果:** 継続的なサービス提供

### 2.2 支払い失敗・リトライ関連

#### 2.2.2 最終的な支払い失敗

**トリガー:** 複数回のリトライ後も支払い不能

- **タイミング:** Stripeの最終リトライ失敗
- **必要な処理:**
    - サブスクリプション状態をPAST_DUEに変更
    - 機能アクセス制限
    - アカウント復旧手順の案内
- **期待する結果:** サービス一時停止、復旧可能状態維持

## 3. Stripe Webhook イベント

### 3.1 Customer関連イベント

#### 3.1.1 customer.created

**トリガー:** Stripe上で新しい顧客が作成されたとき

- **処理内容:**
    - AppUserテーブルのstripeCustomerId更新
    - 顧客情報の同期
- **重要度:** 中

#### 3.1.2 customer.updated

**トリガー:** 顧客情報（メールアドレス、住所など）が更新されたとき

- **処理内容:**
    - 顧客情報のローカル同期
    - メタデータの更新
- **重要度:** 低

### 3.2 Subscription関連イベント

#### 3.2.1 customer.subscription.created

**トリガー:** 新しいサブスクリプションが作成されたとき

- **処理内容:**
    - Subscriptionレコード作成
    - SubscriptionHistoryレコード作成
    - ユーザー権限の有効化
    - 通知メール送信
- **重要度:** 最高

#### 3.2.2 customer.subscription.updated

**トリガー:** サブスクリプション情報が更新されたとき

- **処理内容:**
    - Subscriptionレコード更新
    - SubscriptionHistoryレコード作成
    - プラン制限の再適用
    - Clerkユーザーメタデータ更新
- **重要度:** 最高

#### 3.2.3 customer.subscription.deleted

**トリガー:** サブスクリプションが削除（キャンセル）されたとき

- **処理内容:**
    - Subscriptionステータス更新（CANCELED）
    - SubscriptionHistoryレコード作成
    - 機能アクセス無効化
    - 解約完了通知送信
- **重要度:** 最高

#### 3.2.4 customer.subscription.trial_will_end

**トリガー:** トライアル期間終了の3日前

- **処理内容:**
    - トライアル終了予告通知送信
    - 支払い方法確認案内
- **重要度:** 中

### 3.3 Invoice関連イベント

#### 3.3.1 invoice.created

**トリガー:** 新しい請求書が作成されたとき

- **処理内容:**
    - Invoiceレコード作成
    - 請求予定通知送信（必要に応じて）
- **重要度:** 中

#### 3.3.2 invoice.payment_succeeded

**トリガー:** 請求書の支払いが成功したとき

- **処理内容:**
    - Invoiceステータス更新（paid）
    - Subscriptionの期間延長
    - 支払い完了通知送信
    - 機能アクセス継続確認
- **重要度:** 最高

#### 3.3.3 invoice.payment_failed

**トリガー:** 請求書の支払いが失敗したとき

- **処理内容:**
    - Invoiceステータス更新
    - Subscriptionステータス更新（PAST_DUE）
    - 支払い失敗通知送信
    - 機能アクセス制限
- **重要度:** 最高

#### 3.3.4 invoice.finalized

**トリガー:** 請求書が確定したとき

- **処理内容:**
    - 請求書PDF生成・保存
    - 請求書送付（メール）
- **重要度:** 中

### 3.4 PaymentIntent関連イベント

#### 3.4.1 payment_intent.succeeded

**トリガー:** 支払いインテントが成功したとき

- **処理内容:**
    - 支払い完了ログ記録
    - 関連するInvoiceの更新
- **重要度:** 中

#### 3.4.2 payment_intent.payment_failed

**トリガー:** 支払いインテントが失敗したとき

- **処理内容:**
    - 支払い失敗ログ記録
    - エラー詳細の保存
    - 必要に応じて通知送信
- **重要度:** 中

### 3.5 PaymentMethod関連イベント

#### 3.5.1 payment_method.attached

**トリガー:** 支払い方法が顧客に紐付けられたとき

- **処理内容:**
    - PaymentMethodレコード作成
    - デフォルト支払い方法の更新（必要に応じて）
- **重要度:** 低

#### 3.5.2 payment_method.detached

**トリガー:** 支払い方法が顧客から削除されたとき

- **処理内容:**
    - PaymentMethodレコード無効化
    - 他の支払い方法への切り替え確認
- **重要度:** 中

## 4. 追加で考慮すべきイベント

### 4.1 ビジネスロジック関連

#### 4.1.1 使用量制限超過

**トリガー:** ユーザーがプラン制限を超過したとき

- **処理内容:**
    - 制限超過警告通知
    - アップグレード提案
    - 機能制限の適用
- **重要度:** 高

#### 4.1.2 長期未利用アカウント

**トリガー:** 一定期間サービス未利用のアカウント

- **処理内容:**
    - 利用促進通知送信
    - 解約検討の案内
    - データ保持期間の管理
- **重要度:** 低

### 4.2 管理・運用関連

#### 4.2.1 不正利用検知

**トリガー:** 異常な利用パターンの検知

- **処理内容:**
    - アカウント一時停止
    - 管理者への通知
    - 本人確認プロセス開始
- **重要度:** 高

#### 4.2.2 プラン変更のバッチ処理

**トリガー:** 管理者による一括プラン変更

- **処理内容:**
    - 対象ユーザーの特定
    - 段階的なプラン変更実行
    - 変更結果のレポート生成
- **重要度:** 中

### 4.3 税務・コンプライアンス関連

#### 4.3.1 税率変更

**トリガー:** 地域の税率変更

- **処理内容:**
    - Stripe税設定の更新
    - 既存サブスクリプションへの適用
    - ユーザーへの事前通知
- **重要度:** 中

#### 4.3.2 規約変更

**トリガー:** サービス利用規約の変更

- **処理内容:**
    - 既存ユーザーへの変更通知
    - 同意確認プロセス
    - 非同意ユーザーの処理
- **重要度:** 中

## 5. イベント処理の優先度と信頼性要件

### 5.1 優先度レベル

**最高（即座処理必須）:**

- customer.subscription.created/updated/deleted
- invoice.payment_succeeded/failed

**高（24時間以内処理）:**

- 使用量制限超過
- 不正利用検知

**中（72時間以内処理）:**

- customer.subscription.trial_will_end
- invoice.created/finalized
- payment_method.detached

**低（1週間以内処理）:**

- customer.updated
- 長期未利用アカウント

### 5.2 信頼性要件

**冪等性:** すべてのWebhookイベント処理は冪等性を保証
**リトライ機能:** 失敗したイベント処理の自動リトライ（指数バックオフ）
**監視・アラート:** 重要イベントの処理失敗時は即座にアラート
**ログ記録:** すべてのイベント処理の詳細ログ保存

## 6. セキュリティ要件

**Webhook署名検証:** すべてのStripe Webhookの署名検証実装
**レート制限:** Webhook エンドポイントのレート制限設定
**IP制限:** 可能な場合はStripe IPアドレスからのアクセスのみ許可
**機密情報保護:** API Key、Webhook Secretの適切な管理

## 7. テスト要件

**Test Mode:** 本番前のStripe Test Modeでの完全テスト
**エラーシナリオ:** 支払い失敗、ネットワークエラー等のテスト
**負荷テスト:** 大量のWebhookイベント処理のテスト
**E2Eテスト:** ユーザー操作から結果確認までの完全フローテスト
