# テスト戦略と手法

## TypeScriptプロジェクトにおけるモックとテスト型安全性 (2025-05-07)

### 背景と課題

パーソナルプログラム記事永続化機能のテスト時に、TypeScriptの型エラーに関する課題が発生した。テストで使用するモックデータが正確な型を満たしておらず、テスト実行前にコンパイルエラーが発生していた。とくに複雑なオブジェクト構造を持つスキーマ（PersonalizedProgramScriptなど）のモック作成において、型安全性の確保が課題となった。

### 検討したアプローチ

1. **型定義の無視**:
    - 型キャストや`any`型の使用でエラーを無視
    - メリット: 実装が簡単で迅速
    - デメリット: 型安全性の恩恵を失い、実行時エラーのリスク増加
2. **正確なモックデータ作成**:
    - スキーマ定義を確認し、完全に型に適合したモックデータを作成
    - メリット: 完全な型安全性、テストの信頼性向上
    - デメリット: 実装の手間、スキーマ変更時の保守負担
3. **型アサーションの部分的使用**:
    - 基本構造は正確に実装し、一部のみ型アサーションを使用
    - メリット: 重要な部分の型安全性は保持しつつ、実装負荷軽減
    - デメリット: 部分的に型安全性を犠牲にする

### 決定事項と理由

- 「正確なモックデータ作成」アプローチを採用
- 理由:
  1. テストの信頼性と品質を最優先に考慮
  2. 型エラーの早期発見によるバグ混入防止
  3. スキーマ変更時に影響を受ける箇所が明確になる
  4. モックデータを正確に定義することで実装の理解が深まる

### 実装手法

- **スキーマファイルの参照**: 対象スキーマの定義を直接確認（personalizedProgramScriptSchema等）
- **型修正手順**:
  1. エラーメッセージから不適合な属性を特定（例: `introduction` → `opening`）
  2. 型定義ファイルと実際のコードの不一致を修正
  3. モックデータを型定義に合わせて更新
  4. 部分的に `as` を使った型アサーション（必要最小限で使用）
- **テスト実行前の型チェック**: `tsc --noEmit` によるコンパイルエラーの確認

### 学んだ教訓

1. モックデータ作成時は必ず正確な型定義を参照して実装すべき
2. 型定義とスキーマ変更が同期していることを常に確認する仕組みが重要
3. 単にテストが通ることだけでなく、型安全性も担保することでより信頼性の高いコードを維持できる
4. TypeScriptの型エラーは「面倒な障害」ではなく「早期のバグ発見機会」と捉えるべき
5. モックデータ作成用のユーティリティ/ファクトリ関数の整備が有効

### 関連タスク

- 記事データ保存プロセス実装 (P1)
- 記事永続化テスト (P1)
