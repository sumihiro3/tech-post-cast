# Proプラン実装タスク計画書

## 概要

Tech Post Castの有料プラン（Free/Pro）を実現するための実装タスクを整理します。プレミアム機能へのアクセス制御と課金システムを含む包括的な実装計画です。

## 1. 認証・認可システム

### サブスクリプションステータスチェック機能

- **優先度**: P0
- **状態**: 未着手
- **説明**: 認証プロセスにサブスクリプション状態確認を追加する
- **サブタスク**:
  1. 認証サービスへのサブスクリプションチェック機能追加
  2. ユーザーオブジェクトへのサブスクリプション情報追加
  3. サブスクリプション状態キャッシュ戦略
  4. サブスクリプション状態変更時の再認証処理

### プレミアムガード実装

- **優先度**: P0
- **状態**: 未着手
- **説明**: 有料機能へのアクセスを制限するガード実装
- **サブタスク**:
  1. NestJSガードの実装（PaidPlanGuard）
  2. プレミアム機能エンドポイントへのガード適用
  3. アクセス制限時のエラーレスポンス設計
  4. プレミアムガードのテスト

### 機能アクセス権限管理

- **優先度**: P1
- **状態**: 未着手
- **説明**: さまざまなサブスクリプションプランに応じた機能アクセス権限の管理
- **サブタスク**:
  1. プラン別機能マトリックスの定義
  2. 機能ごとのアクセス権限チェック処理
  3. プラン変更時の権限更新処理
  4. ユーザーロール/プラン情報のキャッシュ管理

## 2. プラン制限の実装

- **優先度**: P0
- **状態**: 未着手
- **説明**: Free/Proプランごとの機能・利用制限を実装する
- **サブタスク**:
  1. パーソナルフィード作成数の制限（Free: 1つ、Pro: 3つ）
  2. 指定著者数・タグ数の制限（Free: 1件、Pro: 5件）
  3. 制限に達した際のUI表示・アップグレード促し
  4. 制限チェックのミドルウェア/ガード実装

## 3. Stripe課金システム

- **優先度**: P0
- **状態**: 未着手
- **説明**: Stripeを用いたProプランの月額課金システムを実装する
- **サブタスク**:
  1. Stripe SDK導入・APIキー設定
  2. 顧客・サブスクリプション管理（作成/更新/キャンセル）
  3. Webhookによる支払い・状態同期
  4. 決済ページ・アップグレードフロー実装
  5. サブスクリプション状態のDB設計・管理

## 4. API制限・レート制限

### API制限実装

- **優先度**: P1
- **状態**: 未着手
- **説明**: プレミアム機能APIへのアクセス制限実装
- **サブタスク**:
  1. エンドポイントごとのアクセス制限適用
  2. APIレスポンスでのアップグレード案内情報追加
  3. APIレスポンスキャッシュの購読状態による分離
  4. アクセス制限ログ記録

### レート制限実装

- **優先度**: P1
- **状態**: 未着手
- **説明**: ユーザープラン別のAPIレート制限実装
- **サブタスク**:
  1. プラン別レート制限設定
  2. レート制限ミドルウェア実装
  3. レート制限ヘッダー実装
  4. レート制限超過時の対応処理

## 5. フロントエンド実装

### プレミアム機能UI制御

- **優先度**: P1
- **状態**: 未着手
- **説明**: フロントエンドでプレミアム機能へのアクセスを制御するUI実装
- **サブタスク**:
  1. プレミアムステータスに基づくUI条件分岐
  2. プレミアム機能へのアクセス時のガイダンス表示
  3. 期限切れ/未購読時のアップグレードCTA実装
  4. プレミアム機能ハイライト表示

### サブスクリプション状態表示

- **優先度**: P1
- **状態**: 未着手
- **説明**: ユーザーに現在のサブスクリプション状態を表示するUI実装
- **サブタスク**:
  1. サブスクリプションステータスバッジ実装
  2. サブスクリプション詳細表示コンポーネント
  3. 期限切れ警告表示
  4. 更新予定通知

### アップグレード促進機能

- **優先度**: P1
- **状態**: 未着手
- **説明**: 無料ユーザー向けのアップグレード促進機能を実装する
- **サブタスク**:
  1. 番組内広告表示機能
  2. 設定画面でのアップグレード促し表示
  3. 制限到達時のアップグレード案内

## 6. セキュリティ対策

### クライアント検証回避対策

- **優先度**: P1
- **状態**: 未着手
- **説明**: フロントエンドでの検証を回避してプレミアム機能にアクセスする試みへの対策
- **サブタスク**:
  1. サーバーサイド検証の徹底
  2. トークン検証強化
  3. APIリクエスト検証
  4. 不正アクセス検出と対応

### サブスクリプション状態監査

- **優先度**: P2
- **状態**: 未着手
- **説明**: サブスクリプション状態と機能アクセスの監査メカニズム
- **サブタスク**:
  1. アクセスログ記録
  2. 定期的なサブスクリプション状態検証
  3. 異常パターン検出
  4. 監査レポート作成

## 7. テスト・検証

### アクセス制御テスト

- **優先度**: P0
- **状態**: 未着手
- **説明**: プレミアム機能アクセス制御の総合テスト
- **サブタスク**:
  1. 各プラン別アクセス権限テスト
  2. サブスクリプション変更時の挙動テスト
  3. 期限切れ処理テスト
  4. エッジケーステスト（キャッシュ、同時アクセスなど）

### パフォーマンス評価

- **優先度**: P2
- **状態**: 未着手
- **説明**: アクセス制御による性能影響の評価
- **サブタスク**:
  1. レイテンシ測定
  2. DB負荷評価
  3. キャッシュ戦略最適化
  4. 高負荷時テスト

## 8. 招待・クーポンシステム

- **優先度**: P2
- **状態**: 未着手
- **説明**: 招待ユーザー向けにProプランを無料提供するクーポンシステムを実装する
- **サブタスク**:
  1. 招待クーポン生成・管理
  2. クーポン適用・認証処理
  3. 招待メール送信
